#
# Munin Cron stats collector
#

FROM dockermediacloud/base:latest

# Install packages
RUN \
    #
    # Install Munin stats collector
    apt-get -y --no-install-recommends install munin && \
    #
    # Install one extra dependency to fix hostname resolution
    # (https://github.com/munin-monitoring/munin/issues/1109#issuecomment-449397665)
    apt-get -y --no-install-recommends install libio-socket-ssl-perl && \
    #
    true

# Symlink logs to STDOUT
RUN \
    rm /var/log/munin/*.log && \
    ln -s /dev/stdout /var/log/munin/munin-cgi-graph.log && \
    ln -s /dev/stdout /var/log/munin/munin-cgi-html.log && \
    ln -s /dev/stdout /var/log/munin/munin-html.log && \
    ln -s /dev/stdout /var/log/munin/munin-limits.log && \
    ln -s /dev/stdout /var/log/munin/munin-update.log && \
    true

# Configure Munin
RUN \
    #
    # Don't generate graphs in Cron job as they'll be generated by CGI script
    sed -i -e "s/^#graph_strategy .*/graph_strategy cgi/" /etc/munin/munin.conf && \
    #
    # Remove localhost from configuration
    sed -i -e "s/^\[localhost.*//" /etc/munin/munin.conf && \
    sed -i -e "s/\s*address 127.*//" /etc/munin/munin.conf && \
    sed -i -e "s/\s*use_node_name 127.*//" /etc/munin/munin.conf && \
    true

# Replace misc. configuration with our own
RUN rm -rf /etc/munin/munin-conf.d/
COPY munin-conf.d/ /etc/munin/munin-conf.d/

# Create directory for PID file
RUN \
    mkdir -p /var/run/munin/ && \
    chown munin:munin /var/run/munin && \
    true

# Copy wrapper script
COPY bin/munin-cron.sh /

# Overwrite crontab with our own
COPY crontab /etc/cron.d/munin

# Volume for RRD data (shared with munin-httpd)
VOLUME /var/lib/munin/

# Volume for generated HTML (shared with munin-httpd)
VOLUME /var/cache/munin/www/

# No USER because wrapper script needs to do some chowning first;
# the command itself will be run as "munin" user

# Set "cron" as default command to run
CMD ["cron", "-f"]
